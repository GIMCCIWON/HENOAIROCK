<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Post">
  
  <!-- 검색조건 -->
  <sql id="searchCondition">
     <choose>
      <when test=" '' != searchWord  and '10' == searchDiv  ">
         AND post_title  LIKE #{searchWord} || '%'
      </when>
      <when test=" '' != searchWord  and '20' == searchDiv  ">
         AND post_contents  LIKE #{searchWord} || '%'
      </when>
     </choose>
  </sql>

  <!-- 게시글 목록조회 -->
  <select id='select' parameterType="com.heno.airock.cmn.DTO" resultType="post">
<!-- SELECT A.*,B.*
    FROM (
        SELECT TT1.rnum as num,
               TT1.post_title,
               TT1.post_div,
               TT1.read_cnt,
               DECODE( TO_CHAR(TT1.update_dt,'YYYYMMDD'),TO_CHAR(sysdate,'YYYYMMDD')
                      ,TO_CHAR(TT1.update_dt,'HH24:MI')
                      ,TO_CHAR(TT1.update_dt,'YYYY/MM/DD') )update_dt,
               TT1.user_id,
               TT1.post_seq
        FROM (
            SELECT ROWNUM as rnum, t1.*
            FROM (
                SELECT *
                FROM posts
                WHERE post_div = #{post_div}
                <include refid="searchCondition"></include>
                ORDER BY update_dt DESC
            )t1
          <![CDATA[     WHERE ROWNUM <= #{pageSize} * (#{pageNo}-1)+#{pageSize}   ]]>
        )TT1
        WHERE rnum >=1
       <![CDATA[    WHERE rnum >=#{pageSize} * (#{pageNo}-1)+ 1 ]]>
    )A
    CROSS JOIN
    (
    SELECT COUNT(post_seq) totalCnt
    FROM posts
    WHERE post_div = #{post_div}
    <include refid="searchCondition"></include>
    )B -->
    SELECT *
    FROM posts
  </select>
  
  <select id="selectOne" parameterType="post" resultType="post">
    SELECT
      post_seq,
      user_id
      post_title,
      post_contents,
      read_cnt,
      like_cnt,
      post_div,
      post_dt,
      update_dt
    FROM posts
    WHERE post_seq = #{post_seq} 
  </select>
  
  
  <insert id='save' parameterType="post">
   INSERT INTO posts (
        post_seq,
        user_id,
        post_title,
        post_contents,
        post_div
    ) VALUES (
        #{post_seq}, 
        #{user_id}, 
        #{post_title}, 
        #{post_contents},
        #{post_div}
    )
  </insert>
  <delete id="delete" parameterType="post">
        DELETE FROM posts 
        WHERE post_seq = #{post_seq} 
  </delete>
  
  
  <update id="updateReadCnt" parameterType="post">
    <![CDATA[
    UPDATE posts
      SET read_cnt = NVL(read_cnt,0) + 1
    WHERE post_seq = #{post_seq}
    AND user_id <> #{user_id}
    ]]> 
  </update>

</mapper>